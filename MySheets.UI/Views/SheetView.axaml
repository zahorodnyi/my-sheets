<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:MySheets.UI.ViewModels.SheetEditor"
             xmlns:sheetEditor="clr-namespace:MySheets.UI.ViewModels.SheetEditor"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="MySheets.UI.Views.SheetView"
             x:DataType="sheetEditor:SheetViewModel"
             Focusable="True"
             PointerReleased="OnPointerReleased"
             PointerMoved="OnPointerMoved">

    <UserControl.Styles>
        <Style Selector="Border.header">
            <Setter Property="Background" Value="#F8F9FA"/>
        </Style>
        <Style Selector="Border.header.active">
            <Setter Property="Background" Value="#D2E3FC"/>
            <Setter Property="TextBlock.Foreground" Value="#1A73E8"/>
            <Setter Property="TextBlock.FontWeight" Value="Bold"/>
        </Style>
    </UserControl.Styles>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="40"/> <ColumnDefinition Width="*"/> <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="25"/> <RowDefinition Height="*"/> 
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Grid.Column="0" Background="#F8F9FA" BorderBrush="#C0C0C0" BorderThickness="0,0,1,1" ZIndex="10"/>

        <ScrollViewer Grid.Row="0" Grid.Column="1" x:Name="ColHeaderScrollViewer" HorizontalScrollBarVisibility="Hidden" VerticalScrollBarVisibility="Disabled">
            <ItemsControl ItemsSource="{Binding ColumnHeaders}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate><StackPanel Orientation="Horizontal"/></ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Panel Width="{Binding Width}">
                            <Border Classes="header" Classes.active="{Binding IsActive}" BorderBrush="#C0C0C0" BorderThickness="0,0,1,1">
                                <TextBlock Text="{Binding Header}" HorizontalAlignment="Center" VerticalAlignment="Center" FontWeight="SemiBold" Foreground="#333333"/>
                            </Border>
                            <Border Width="5" HorizontalAlignment="Right" Background="Transparent" Cursor="SizeWestEast" Tag="{Binding}" PointerPressed="OnColumnHeaderPressed"/>
                        </Panel>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <Border Grid.Row="0" Grid.Column="2" Grid.RowSpan="2" Background="#F0F0F0" BorderBrush="#C0C0C0" BorderThickness="0,0,0,1" Padding="2,2,2,0" VerticalAlignment="Stretch">
            <StackPanel Orientation="Vertical" VerticalAlignment="Top" Spacing="2">
                <Button Classes="round" Content="+" Command="{Binding AddColumnCommand}" ToolTip.Tip="Add Column"/>
                <Button Classes="round" Content="-" Command="{Binding RemoveColumnCommand}" ToolTip.Tip="Remove Last Column"/>
            </StackPanel>
        </Border>

        <ScrollViewer Grid.Row="1" Grid.Column="0" x:Name="RowHeaderScrollViewer" HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Hidden">
            <ItemsControl ItemsSource="{Binding Rows}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate><StackPanel Orientation="Vertical"/></ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="sheetEditor:RowViewModel">
                        <Panel Height="{Binding Height}">
                            <Border Classes="header" Classes.active="{Binding IsActive}" BorderBrush="#C0C0C0" BorderThickness="0,0,1,1">
                                <TextBlock Text="{Binding Header}" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="#333333" FontSize="12"/>
                            </Border>
                            <Border Height="5" VerticalAlignment="Bottom" Background="Transparent" Cursor="SizeNorthSouth" Tag="{Binding}" PointerPressed="OnRowHeaderPressed"/>
                        </Panel>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <ScrollViewer Grid.Row="1" Grid.Column="1" x:Name="MainScrollViewer" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
            <Panel x:Name="CellPanel" Background="Transparent" Focusable="True">
                <ItemsControl ItemsSource="{Binding Rows}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate><StackPanel Orientation="Vertical"/></ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="sheetEditor:RowViewModel">
                            <ItemsControl ItemsSource="{Binding Cells}" Height="{Binding Height}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate><StackPanel Orientation="Horizontal"/></ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="sheetEditor:CellViewModel">
                                        <Border BorderBrush="#D9D9D9" 
                                                BorderThickness="{Binding BorderThickness}" 
                                                Width="{Binding Column.Width}" 
                                                Background="{Binding Background}">
                                            <Panel ClipToBounds="False">
                                                <TextBlock Text="{Binding Value}" 
                                                           Foreground="{Binding Foreground}"
                                                           FontSize="{Binding FontSize}"
                                                           FontWeight="{Binding FontWeight}"
                                                           FontStyle="{Binding FontStyle}"
                                                           VerticalAlignment="Center" 
                                                           HorizontalAlignment="Left"
                                                           Padding="0,0,5,0"
                                                           Margin="9,0,0,0"/>
                                            </Panel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <Canvas x:Name="OverlayCanvas">
                    
                    <Border BorderBrush="#1A73E8" BorderThickness="1" Background="#201A73E8" 
                            IsVisible="{Binding IsSelectionVisible}" 
                            IsHitTestVisible="False"
                            Canvas.Left="{Binding SelectionX}" 
                            Canvas.Top="{Binding SelectionY}" 
                            Width="{Binding SelectionWidth}" 
                            Height="{Binding SelectionHeight}"/>
                    
                    <Rectangle Stroke="#F29900" 
                                StrokeThickness="2" 
                                Fill="Transparent"
                                RadiusX="2"
                                RadiusY="2"
                                IsVisible="{Binding IsRefSelectionVisible}"
                                IsHitTestVisible="False"
                                StrokeDashArray="4,2"
                                Canvas.Left="{Binding RefSelectionX}"
                                Canvas.Top="{Binding RefSelectionY}"
                                Width="{Binding RefSelectionWidth}"
                                Height="{Binding RefSelectionHeight}"/>
                                
                    <Border x:Name="ActiveCellBorder"
                            BorderBrush="#1A73E8" 
                            BorderThickness="2" 
                            Background="Transparent"
                            IsHitTestVisible="False"
                            IsVisible="False"/>

                    <TextBox x:Name="FloatingEditor"
                             IsVisible="False"
                             Background="White"
                             BorderThickness="0"
                             MinHeight="0"
                             Padding="9,0,0,0"
                             CornerRadius="0"
                             FontSize="12"
                             VerticalContentAlignment="Center"
                             HorizontalAlignment="Left"
                             VerticalAlignment="Top"/>
                </Canvas>
            </Panel>
        </ScrollViewer>

        <Grid x:Name="ValidationPopup" Grid.RowSpan="2" Grid.ColumnSpan="3" Background="#50000000" IsVisible="False">
            <Border Background="White" BorderBrush="#C0C0C0" BorderThickness="1" CornerRadius="4" 
                    HorizontalAlignment="Center" VerticalAlignment="Center" 
                    Padding="20" MinWidth="300" BoxShadow="0 4 10 0 #40000000">
                <StackPanel Spacing="15">
                    <TextBlock Text="⚠️ Invalid Formula" FontWeight="Bold" FontSize="16" Foreground="#D93025"/>
                    <TextBlock Text="It looks like your formula is invalid. Please try changing it." 
                               TextWrapping="Wrap" FontSize="14" Foreground="#333333"/>
                    <Button Content="OK" HorizontalAlignment="Right" Click="OnValidationOkClick"
                            Background="#1A73E8" Foreground="White" Padding="15,6" CornerRadius="4"/>
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</UserControl>